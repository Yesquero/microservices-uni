version: "3.9"

services:
    postgres-db:
        image: postgres:latest
        restart: always
        environment:
            POSTGRES_PASSWORD: sample-password
        volumes:
            - /var/local/pgdata:/var/lib/postgresql/data

    first:
        build: firstbackend
        depends_on:
            - postgres-db
        environment:
            SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-db:5432/postgres
            OTEL_SERVICE_NAME: "second-backend"
            OTEL_EXPORTER_OTLP_ENDPOINT: "http://collector:4317"
            # Logs are disabled by default
            OTEL_LOGS_EXPORTER: "otlp"
        ports:
            - 8081:8081

    second:
        build: secondbackend
        depends_on:
            - postgres-db
        environment:
            SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-db:5432/postgres
            OTEL_SERVICE_NAME: "second-backend"
            OTEL_EXPORTER_OTLP_ENDPOINT: "http://collector:4317"
            # Logs are disabled by default
            OTEL_LOGS_EXPORTER: "otlp"
        ports:
            - 8082:8082

    api-gateway:
        image: devopsfaith/krakend:watch
        volumes:
            - ./api-gateway:/etc/krakend
        ports:
            - 8080:8080
        command: ["run", "-d", "-c", "/etc/krakend/krakend.json"]

    jaeger:
        image: jaegertracing/all-in-one:latest
        ports:
            - 16686:16686
            - 6831:6831/udp
            - 14268:14268
            - 14250:14250

    collector:
        image: otel/opentelemetry-collector-contrib:latest
        command: [ "--config=/etc/otel-collector-config.yaml" ]
        volumes:
            - ./otel-config.yaml:/etc/otel-collector-config.yaml
        expose:
            - 4317
            - 4318
        ports:
            - 1888:1888   # pprof extension
            - 13133:13133 # health_check extension
            - 4317:4317       # OTLP gRPC receiver
            - 4318:4318        # OTLP http reciever
            - 55670:55679 # zpages extension
        depends_on:
            - jaeger
